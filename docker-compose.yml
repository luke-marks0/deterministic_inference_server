services:
  vllm:
    image: ${VLLM_IMAGE}
    container_name: qwen3_vllm_reference
    gpus: all
    ipc: host
    restart: unless-stopped
    ulimits:
      memlock: -1
      stack: 67108864
    ports:
      - "${VLLM_PORT}:8000"
    volumes:
      - ./state/hf:/data/hf
      - ./artifacts:/artifacts
    environment:
      HF_HOME: /data/hf
      HUGGING_FACE_HUB_TOKEN: ${HUGGING_FACE_HUB_TOKEN}
      CUDA_DEVICE_MAX_CONNECTIONS: "1"
      # cuBLAS deterministic workspace setting.
      CUBLAS_WORKSPACE_CONFIG: ":4096:8"
    command:
      - --model
      - ${MODEL_ID}
      - --revision
      - ${MODEL_REVISION}
      - --served-model-name
      - ${SERVED_MODEL_NAME}
      - --dtype
      - float16
      - --host
      - 0.0.0.0
      - --port
      - "8000"
      - --tensor-parallel-size
      - ${TENSOR_PARALLEL_SIZE}
      - --pipeline-parallel-size
      - ${PIPELINE_PARALLEL_SIZE}
      - --max-model-len
      - ${MAX_MODEL_LEN}
      - --seed
      - ${VLLM_SEED}
      - --max-num-seqs
      - "1"
      - --enforce-eager
      - --disable-log-requests
